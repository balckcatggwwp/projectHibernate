<%@page import="java.util.List"%>
<%@page import="com.menu.bean.MenuBean"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ğŸ½ èœå–®åˆ—è¡¨</title>

<!-- å¼•å…¥ Bootstrap -->
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">

<!-- DataTables CSS -->
<link rel="stylesheet"
	href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">

<style>
body {
	background-color: #f8f9fa;
}

table {
	background-color: white;
}

th {
	background-color: #007bff;
	color: white;
	text-align: center;
}

td {
	text-align: center;
	vertical-align: middle;
}

img {
	width: 100px;
	height: auto;
	border-radius: 5px;
}

.btn-back {
	display: block;
	width: 200px;
	margin: 20px auto;
	padding: 10px;
	text-align: center;
	background-color: #28a745;
	color: white;
	text-decoration: none;
	border-radius: 5px;
}

.btn-back:hover {
	background-color: #218838;
}

.btn-sm {
	margin-right: 5px;
}
</style>
</head>
<body>
	<%-- ğŸ”¹ é¡¯ç¤ºåˆªé™¤çµæœè¨Šæ¯ --%>
	<%
	String deleteMessage = (String) session.getAttribute("deleteMessage");
	if (deleteMessage != null) {
	%>
	<div class="alert alert-info text-center" role="alert">
		<%=deleteMessage%>
	</div>
	<%
	session.removeAttribute("deleteMessage"); // æ¸…é™¤è¨Šæ¯ï¼Œé¿å…é‡è¤‡é¡¯ç¤º
	}
	%>
	<div class="container mt-5">
		<h2 class="text-center mb-4">ğŸ½ èœå–®ä¸€è¦½</h2>

		<!-- ğŸ”¹ åµéŒ¯ï¼šç¢ºèª `menuList` æ˜¯å¦æœ‰è³‡æ–™ -->

		<%
		/*
		List<MenuBean> menuList = (List<MenuBean>) request.getAttribute("menuList");
		       	 if (menuList == null || menuList.isEmpty()) {
		    out.println("<p class='text-center text-danger'>âŒ `menuList` ç‚ºç©ºï¼Œè«‹æª¢æŸ¥å¾Œç«¯ï¼</p>");
		} else {
		    out.println("<p class='text-center text-success'>âœ… `menuList` æœ‰ " + menuList.size() + " ç­†è³‡æ–™ï¼</p>");
		}
		       	 */
		%>


		<table class="table table-bordered table-hover" id="menuTable">
			<thead class="table-dark">
				<tr>
					<th>å•†å“åç¨±</th>
					<th>åº«å­˜</th>
					<th>åœ–ç‰‡</th>
					<th>å–®åƒ¹</th>
					<th>ä»‹ç´¹</th>
					<th>ç‹€æ…‹</th>
					<th>é¡åˆ¥</th>
					<th>æ“ä½œ</th>
				</tr>
			</thead>
			<tbody>
				<c:choose>
					<c:when test="${not empty menuList}">
						<c:forEach var="mn" items="${menuList}">
							<tr>
								<td>${mn.menu_name}</td>
								<td>${mn.stock}</td>
								<td><img
									src="${pageContext.request.contextPath}${mn.image_url}"
									alt="å•†å“åœ–ç‰‡" class="img-thumbnail"></td>

								<td>${mn.unit_price}</td>
								<td>${mn.description}</td>
								<td>${mn.status}</td>
								<td>${mn.category}</td>
								<td>
									<!-- âœ… ä¿®æ­£ä¿®æ”¹æŒ‰éˆ•çš„ `data-menu-name` -->
									<button class="edit-btn btn btn-warning"
										data-menu-name="${mn.menu_name}">ä¿®æ”¹</button>
									<button class="btn btn-danger delete-btn"
										data-menu-name="${mn.menu_name}">åˆªé™¤</button>
								</td>
							</tr>
						</c:forEach>
					</c:when>
					<c:otherwise>
						<tr>
							<td colspan="8" class="text-center text-danger">âŒ æ²’æœ‰æ‰¾åˆ°èœå–®å“é …ã€‚</td>
						</tr>
					</c:otherwise>
				</c:choose>
			</tbody>
		</table>

		<!-- è¿”å›æŒ‰éˆ• -->
		<a href="<%=request.getContextPath()%>/hw2/menupage.html"
			class="btn-back">è¿”å›æŸ¥è©¢é é¢</a>
	</div>

	<!-- jQuery -->
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

	<!-- DataTables -->
	<script
		src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

	<!-- å•Ÿå‹• DataTables -->
	<script>
        $(document).ready(function(){
            $('#menuTable').DataTable({
                "language": {
                    "lengthMenu": "é¡¯ç¤º _MENU_ ç­†è¨˜éŒ„",
                    "zeroRecords": "æ²’æœ‰ç¬¦åˆçš„è¨˜éŒ„",
                    "info": "é¡¯ç¤ºç¬¬ _START_ ç­†åˆ°ç¬¬ _END_ ç­†ï¼Œå…± _TOTAL_ ç­†",
                    "infoEmpty": "æ²’æœ‰å¯é¡¯ç¤ºçš„è¨˜éŒ„",
                    "infoFiltered": "(å¾ _MAX_ ç­†è¨˜éŒ„ä¸­ç¯©é¸)",
                    "search": "æœå°‹ï¼š",
                    "paginate": {
                        "first": "ç¬¬ä¸€é ",
                        "last": "æœ€å¾Œä¸€é ",
                        "next": "ä¸‹ä¸€é ",
                        "previous": "ä¸Šä¸€é "
                    }
                }
            });
        });

        // âœ… JavaScript è®“ã€Œä¿®æ”¹ã€æŒ‰éˆ•å°å‘
        document.addEventListener("DOMContentLoaded", function() {
            document.querySelectorAll(".edit-btn").forEach(button => {
                button.addEventListener("click", function() {
                    let menuName = this.getAttribute("data-menu-name");
                    if (!menuName) {
                        console.error("âŒ éŒ¯èª¤ï¼šç„¡æ³•ç²å– `menu_name`ï¼Œè«‹æª¢æŸ¥ `data-menu-name` å±¬æ€§");
                        return;
                    }

                    let encodedMenuName = encodeURIComponent(menuName); // âœ… ç¢ºä¿æ­£ç¢ºç·¨ç¢¼
                    
                    window.location.href = `/project/hw2/Updatemovie.html?menu_name=` + menuName;
                    
                });
            });
        });
        
        
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".delete-btn").forEach(button => {
                button.addEventListener("click", function () {
                    let menuName = this.getAttribute("data-menu-name");

                    if (confirm("ç¢ºå®šè¦åˆªé™¤ã€Œ" + menuName + "ã€å—ï¼Ÿ")) {
                        fetch("/project/DeleteM", {
                            method: "POST",
                            headers: { "Content-Type": "application/x-www-form-urlencoded" },
                            body: "menu_name=" + encodeURIComponent(menuName)
                        })
                        
                        .then(response => {
                            if (!response.ok) {
                                throw new Error("ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤ï¼š" + response.status);
                            }                           
                            return response.json(); // è§£æ JSON
                        })
                        .then(data => {
                        	console.log("ä¼ºæœå™¨å›æ‡‰ JSON:", data);
                            if (data.success) {
                            	console.log('success')
                                console.log("âœ… åˆªé™¤æˆåŠŸï¼Œé‡æ•´é é¢...");
                                location.reload(); // åˆªé™¤æˆåŠŸå¾Œé‡æ•´é é¢
                            } else {
                                alert("âŒ åˆªé™¤å¤±æ•—ï¼š" + data.message);
                            }
                        })
                        .catch(error => {
                            console.error("âŒ åˆªé™¤éŒ¯èª¤:", error);
                            alert("âŒ åˆªé™¤è«‹æ±‚å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
                        });
                    }
                });
            });
        });
    </script>

</body>
</html>