package com.menu.model;

import java.util.List;
import org.hibernate.Session;
import org.hibernate.SessionFactory;
import org.hibernate.Transaction;
import org.hibernate.query.Query;

import com.menu.bean.MenuBean;
import com.menu.interfac.ImenuDAO;
import com.tick.util.HibernateUtil;

public class movietheaterDao implements ImenuDAO {

    private SessionFactory sessionFactory;

    public movietheaterDao() {
        this.sessionFactory = HibernateUtil.getSessionFactory();
    }

    // **æ–°å¢èœå–®**
    @Override
    public boolean insertMenu(MenuBean menu) {
        boolean success = false;
        Transaction tx = null;
        try (Session session = sessionFactory.openSession()) {
            tx = session.beginTransaction();
            session.save(menu);
            tx.commit();
            success = true;
            System.out.println("âœ… æ–°å¢æˆåŠŸï¼š" + menu.getMenuName());
        } catch (Exception e) {
            if (tx != null) tx.rollback();
            System.out.println("âŒ æ–°å¢èœå–®å¤±æ•—ï¼š" + e.getMessage());
            e.printStackTrace();
        }
        return success;
    }

    // **æ›´æ–°èœå–®**
    @Override
    public boolean updateMenu(MenuBean menu) {
        boolean success = false;
        Transaction tx = null;
        try (Session session = sessionFactory.openSession()) {
            tx = session.beginTransaction();
            session.update(menu);
            tx.commit();
            success = true;
            System.out.println("âœ… æ›´æ–°æˆåŠŸï¼š" + menu.getMenuName());
        } catch (Exception e) {
            if (tx != null) tx.rollback();
            System.out.println("âŒ æ›´æ–°èœå–®å¤±æ•—ï¼š" + e.getMessage());
            e.printStackTrace();
        }
        return success;
    }

    // **åˆªé™¤èœå–®**
    @Override
    public boolean deleteMenu(String menuName) {
        boolean success = false;
        Transaction tx = null;
        try (Session session = sessionFactory.openSession()) {
            tx = session.beginTransaction();
            Query<?> query = session.createQuery("DELETE FROM MenuBean WHERE menuName = :menuName");
            query.setParameter("menuName", menuName);
            int rows = query.executeUpdate();
            tx.commit();
            success = rows > 0;
            System.out.println(success ? "âœ… æˆåŠŸåˆªé™¤èœå–®ï¼š" + menuName : "âŒ åˆªé™¤å¤±æ•—ï¼Œèœå–®ä¸å­˜åœ¨ï¼š" + menuName);
        } catch (Exception e) {
            if (tx != null) tx.rollback();
            System.out.println("âŒ åˆªé™¤èœå–®å¤±æ•—ï¼š" + e.getMessage());
            e.printStackTrace();
        }
        return success;
    }

    // **æŸ¥è©¢å–®ç­†èœå–®**
    @Override
    public MenuBean getMenuByName(String menuName) {
        Transaction transaction = null;
        MenuBean menu = null;
        try (Session session = HibernateUtil.getSessionFactory().openSession()) {
            transaction = session.beginTransaction();

            System.out.println("ğŸ” æŸ¥è©¢ SQLï¼šmenu_name = " + menuName);

            Query<MenuBean> query = session.createQuery(
                "FROM MenuBean WHERE menuName = :name", MenuBean.class);
            query.setParameter("name", menuName.trim());  // âœ… ç¢ºä¿æ²’æœ‰å¤šé¤˜ç©ºæ ¼

            menu = query.uniqueResult();

            if (menu == null) {
                System.out.println("âŒ æ‰¾ä¸åˆ°èœå–®ï¼š" + menuName);
            } else {
                System.out.println("âœ… æ‰¾åˆ°èœå–®ï¼š" + menu.getMenuName());
            }

            transaction.commit();
        } catch (Exception e) {
            if (transaction != null) transaction.rollback();
            e.printStackTrace();
        }
        return menu;
    }
    // **æŸ¥è©¢æ‰€æœ‰èœå–®**
    @Override
    public List<MenuBean> getAllMenus() {
        List<MenuBean> menuList = null;
        try (Session session = sessionFactory.openSession()) {
            Query<MenuBean> query = session.createQuery("FROM MenuBean ORDER BY category, menuName", MenuBean.class);
            menuList = query.getResultList();
            System.out.println("âœ… æŸ¥è©¢æˆåŠŸï¼Œå…± " + menuList.size() + " ç­†è³‡æ–™");
        } catch (Exception e) {
            System.out.println("âŒ æŸ¥è©¢æ‰€æœ‰èœå–®å¤±æ•—ï¼š" + e.getMessage());
            e.printStackTrace();
        }
        return menuList;
    }

    // **æŸ¥è©¢èœå–®åƒ¹æ ¼**
    @Override
    public int getPriceByMenuName(String menuName) {
        int price = 0;
        try (Session session = sessionFactory.openSession()) {
            Query<Integer> query = session.createQuery("SELECT unit_price FROM MenuBean WHERE menu_name = :menuName", Integer.class);
            query.setParameter("menuName", menuName);
            price = query.uniqueResult();
            System.out.println("âœ… æŸ¥è©¢åƒ¹æ ¼æˆåŠŸï¼š" + menuName + " = " + price);
        } catch (Exception e) {
            System.out.println("âŒ æŸ¥è©¢åƒ¹æ ¼å¤±æ•—ï¼š" + e.getMessage());
            e.printStackTrace();
        }
        return price;
    }

}
